<!doctype html>

<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mobiln√≠ Oper√°tor Tycoon ‚Äî Prototyp</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body,#map{height:100%;margin:0;padding:0;font-family:Inter, Arial, sans-serif}
  .hud{position:absolute;left:10px;top:10px;z-index:1100;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
  .hud div{margin:4px 0}
  .hamburger{position:absolute;right:10px;top:10px;z-index:1200}
  .hamburger button{background:#111;color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer}
  .menu{position:absolute;right:10px;top:56px;z-index:1200;background:rgba(255,255,255,0.98);padding:12px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.2);display:none}
  .menu h3{margin:0 0 8px 0}
  .menu button{display:block;margin:6px 0;padding:8px;border-radius:6px;border:none;background:#333;color:#fff;cursor:pointer;transition:background 0.2s}
  .menu button:hover{background:#555}
  .legend{position:absolute;left:10px;bottom:10px;z-index:1100;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px}
  .legend div{display:flex;align-items:center;margin:4px}
  .sw{width:18px;height:12px;margin-right:8px;border-radius:3px}
</style>
</head>
<body>
<div id="map"></div>
<div class="hud" id="hud">
  <div><strong>Penƒõz:</strong> <span id="money">200000</span> Kƒç</div>
  <div><strong>Z√°kazn√≠k≈Ø:</strong> <span id="customers">1000</span></div>
  <div><strong>P≈ô√≠jem/s:</strong> <span id="income">0</span> Kƒç/s</div>
</div>
<div class="hamburger">
  <button id="hambBtn">‚ò∞ Menu</button>
  <div class="menu" id="menu">
    <h3>Akce</h3>
    <button id="addTxBtn">Postavit vys√≠laƒç</button>
    <button id="addShopBtn">Postavit poboƒçku</button>
    <button id="promoBtn">Spustit promo (sleva)</button>
    <hr />
    <div style="font-size:12px;color:#fff">Tip: Klikni na mapu pro um√≠stƒõn√≠ objektu po zvolen√≠ akce.</div>
  </div>
</div>
<div class="legend">
  <div><div class="sw" style="background:#006400"></div> V√Ωborn√Ω</div>
  <div><div class="sw" style="background:#2ecc71"></div> Velmi dobr√Ω</div>
  <div><div class="sw" style="background:#f1c40f"></div> Dobr√Ω</div>
  <div><div class="sw" style="background:#e67e22"></div> u≈æ nic moc</div>
  <div><div class="sw" style="background:#e74c3c"></div> slab√Ω</div>
  <div><div class="sw" style="background:#800000"></div> ≈æ√°dn√Ω</div>
</div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script><script>
let money = 200000;
let customers = 0;
let incomePerCustomerPerSec = 0.2;

const prahaCenter = [50.087451, 14.420671];
const map = L.map('map').setView(prahaCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
// üîÅ Schov√°v√°n√≠ ikon vys√≠laƒç≈Ø p≈ôi odd√°len√≠
map.on('zoomend', () => {
  const zoom = map.getZoom();
  if (zoom < 11) {
    map.removeLayer(txLayer); // schov√° v≈°echny vys√≠laƒçe
  } else {
    if (!map.hasLayer(txLayer)) map.addLayer(txLayer); // znovu je zobraz√≠
  }
});
  
  loadGame();
  
  
  
  function loadGame() {
  const stateStr = localStorage.getItem('mobOperatorGame');
  if (!stateStr) return;

  try {
    const state = JSON.parse(stateStr);
    money = state.money || 200000;
    customers = state.customers || 1000;

    // naƒç√≠st vys√≠laƒçe
    state.txs?.forEach(t => {
      addTransmitter(t.latlng, t.power);
    });

    // naƒç√≠st poboƒçky
    state.shops?.forEach(s => {
      addShop(s.latlng);
    });

    updateHUD();
    console.log('Stav hry naƒçten');
  } catch(e) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stavu hry:', e);
  }
}
  
  setInterval(saveGame, 60000); // 60000 ms = 60 s

 
  
const txLayer = L.layerGroup().addTo(map);
const shopLayer = L.layerGroup().addTo(map);
const coverageLayer = L.layerGroup().addTo(map);

const moneyEl = document.getElementById('money');
const custEl = document.getElementById('customers');
const incomeEl = document.getElementById('income');
const menuEl = document.getElementById('menu');

document.getElementById('hambBtn').addEventListener('click', ()=>{menuEl.style.display = menuEl.style.display==='block'?'none':'block'});

let mode = null;
let pendingTxPower = 10;

document.getElementById('addTxBtn').addEventListener('click', ()=>{
  mode = 'tx';
  pendingTxPower = parseInt(prompt('Zadej v√Ωkon vys√≠laƒçe (5,10,20,25) W','10')) || 10;
  alert('Klikni na mapu pro um√≠stƒõn√≠ vys√≠laƒçe.');
});

document.getElementById('addShopBtn').addEventListener('click', ()=>{
  mode = 'shop';
  alert('Klikni na mapu pro um√≠stƒõn√≠ poboƒçky.');
});

document.getElementById('promoBtn').addEventListener('click', ()=>{runPromo();});

map.on('click', (e)=>{
  if(mode==='tx'){
    const cost = costForTx(pendingTxPower);
    if(money<cost){alert('Nem√°≈° dost penƒõz na tento vys√≠laƒç.'); return}
    money -= cost; updateHUD(); addTransmitter(e.latlng, pendingTxPower);
    mode=null; menuEl.style.display='none';
  } else if(mode==='shop'){
    const cost=50000;
    if(money<cost){alert('Nem√°≈° dost penƒõz na poboƒçku.'); return}
    money -= cost; updateHUD(); addShop(e.latlng);
    mode=null; menuEl.style.display='none';
  }
});

function costForTx(power) {
  if (power <= 5) return 10000;
  if (power >= 25) return 100000;

  const minPower = 5, maxPower = 25;
  const minCost = 10000, maxCost = 100000;
  const exponent = 1.5; // >1 = rostouc√≠ rychleji, <1 = pomaleji

  let normalized = (power - minPower) / (maxPower - minPower);
  let cost = minCost + Math.pow(normalized, exponent) * (maxCost - minCost);

  return Math.round(cost);
}
function addTransmitter(latlng, power){
  const txIcon = L.icon({
    iconUrl: 'https://i.imgur.com/v3yKg3b.png', // tv≈Øj obr√°zek
    iconSize: [32, 32], // velikost ikony (px)
    iconAnchor: [16, 32], // bod, kter√Ω bude p≈ôesnƒõ na sou≈ôadnici markeru (st≈ôed spodn√≠ ƒç√°sti)
    popupAnchor: [0, -32] // kde se otev≈ôe popup v≈Øƒçi ikonƒõ
  });

  const marker = L.marker(latlng, {
    title: `Vys√≠laƒç ${power}W`,
    icon: txIcon
  }).addTo(txLayer);

  marker.bindPopup(`<b>Vys√≠laƒç</b><br>${power} W`);
  computeCoverage();
}

function addShop(latlng){
  const marker = L.marker(latlng,{title:'Poboƒçka',icon:L.divIcon({className:'shop-icon',html:'üè¨',iconSize:[28,28]})}).addTo(shopLayer);
  marker.bindPopup('<b>Poboƒçka</b>');
  customers += 500; updateHUD();
}

// --- debounce helper ---
function debounce(func, wait = 100) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  }
}

// --- upraven√Ω computeCoverage ---
function computeCoverage() {
  coverageLayer.clearLayers();

  const txs = [];
  txLayer.eachLayer(l => {
    txs.push({
      latlng: l.getLatLng(),
      power: parseInt(l.options.title?.match(/(\d+)/)?.[0] || 10)
    });
  });
  if (txs.length === 0) return;

  // Dynamick√Ω krok podle zoomu
  let step;
  const zoom = map.getZoom();
  if (zoom < 10) step = 0.004;      
  else if (zoom < 12) step = 0.002; 
  else step = 0.001;                

  // Pouze aktu√°ln√≠ viewport
  const bounds = map.getBounds();
  let south = bounds.getSouth();
  let north = bounds.getNorth();
  let west = bounds.getWest();
  let east = bounds.getEast();

  // Omezit poƒçet ƒçtverc≈Ø (max 2000)
  const maxSquares = 2000;
  const numSquares = Math.ceil((north - south) / step) * Math.ceil((east - west) / step);
  if (numSquares > maxSquares) {
    const scale = Math.sqrt(numSquares / maxSquares);
    step *= scale;
  }

  // Barvy sign√°lu
  const baseColors = ['#00ff00', '#ffff00', '#ffa500', '#ff0000'];
  const colorBands = [];
  for (let i = 0; i < baseColors.length - 1; i++) {
    let start = hexToRgb(baseColors[i]);
    let end = hexToRgb(baseColors[i + 1]);
    for (let j = 0; j < 5; j++) {
      let t = j / 4;
      let r = Math.round(start.r + (end.r - start.r) * t);
      let g = Math.round(start.g + (end.g - start.g) * t);
      let b = Math.round(start.b + (end.b - start.b) * t);
      colorBands.push(rgbToHex(r, g, b));
    }
  }
  colorBands.push(baseColors[baseColors.length - 1]);

  const signalScale = 12;
  const decay = 1.8;
  const noiseStrength = 0.25;
  const overlapFactor = 0.9;

  for (let lat = south; lat <= north; lat += step) {
    for (let lng = west; lng <= east; lng += step) {
      const pt = turf.point([lng, lat]);
      let totalSignal = 0;

      txs.forEach(t => {
        let dist = turf.distance(turf.point([t.latlng.lng, t.latlng.lat]), pt, { units: 'kilometers' });
        if (dist > signalScale) return;

        let signal = t.power / Math.pow(Math.max(dist, 0.05), decay);
        signal *= (1 - noiseStrength / 2 + Math.random() * noiseStrength);
        if (dist < signalScale / 4) signal *= 1.2;

        totalSignal += signal * overlapFactor;
      });

      const norm = Math.log1p(totalSignal) * 5;
      const idx = Math.max(0, Math.min(colorBands.length - 1, colorBands.length - 1 - Math.floor(norm)));
      const color = colorBands[idx];
      const opacity = 0.4;

      const rect = L.rectangle(
        [
          [lat, lng],
          [lat + step, lng + step]
        ],
        { fillColor: color, fillOpacity: opacity, stroke: false }
      );

      coverageLayer.addLayer(rect);
    }
  }
}

// --- automatick√© p≈ôekreslov√°n√≠ p≈ôi pohybu mapy nebo zoomu ---
const computeCoverageDebounced = debounce(computeCoverage, 150);

map.on('moveend', computeCoverageDebounced);
map.on('zoomend', computeCoverageDebounced);  

function hexToRgb(hex){
  let num = parseInt(hex.replace('#',''),16);
  return {r:(num>>16)&255, g:(num>>8)&255, b:num&255};
}

function rgbToHex(r,g,b){
  return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}  function updateHUD(){
  moneyEl.textContent = Math.round(money).toLocaleString('cs-CZ');
  custEl.textContent = Math.round(customers).toLocaleString('cs-CZ');
  incomeEl.textContent = (customers*incomePerCustomerPerSec).toFixed(2);
}

setInterval(()=>{
  const income = customers*incomePerCustomerPerSec;
  money += income;
  updateHUD();
},1000);

  // P≈ôirozen√Ω r≈Øst z√°kazn√≠k≈Ø
setInterval(()=>{
  // n√°hodnƒõ 1‚Äì5 nov√Ωch z√°kazn√≠k≈Ø za sekundu
  const newCust = Math.floor(Math.random() * 15) + 1;
  customers += newCust;
  updateHUD();
},1000);

function runPromo(){
  const cost=200000;
  if(money<cost){alert('Nem√°≈° dost penƒõz na promo.'); return}
  money-=cost; updateHUD();
  customers+=1000; updateHUD();
  setTimeout(()=>{customers-=1000;},20000);
}

addTransmitter(L.latLng(prahaCenter[0]+0.01,prahaCenter[1]+0.01),10);
updateHUD();
  
  function saveGame() {
  const txs = [];
  txLayer.eachLayer(l => {
    txs.push({
      latlng: l.getLatLng(),
      power: parseInt(l.options.title?.match(/(\d+)/)?.[0] || 10)
    });
  });

  const shops = [];
  shopLayer.eachLayer(l => {
    shops.push({
      latlng: l.getLatLng()
    });
  });

  const state = {
    money,
    customers,
    txs,
    shops
  };

  localStorage.setItem('mobOperatorGame', JSON.stringify(state));
  console.log('Stav hry ulo≈æen');
}
  
  function loadGame() {
  const stateStr = localStorage.getItem('mobOperatorGame');
  if (!stateStr) return;

  try {
    const state = JSON.parse(stateStr);
    money = state.money || 200000;
    customers = state.customers || 1000;

    // naƒç√≠st vys√≠laƒçe
    state.txs?.forEach(t => {
      addTransmitter(t.latlng, t.power);
    });

    // naƒç√≠st poboƒçky
    state.shops?.forEach(s => {
      addShop(s.latlng);
    });

    updateHUD();
    console.log('Stav hry naƒçten');
  } catch(e) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stavu hry:', e);
  }
}
  
  setInterval(saveGame, 60000); // 60000 ms = 60 s

</script></body>
</html>